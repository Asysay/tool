<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{title}}</title>
   	<!-- Requires jQuery -->
	<script src="{{ url_for('static', filename='js/jquery.min.js')}}" type="text/javascript"></script>

    <!-- Requires CodeMirror -->
    <script src="{{ url_for('static', filename='js/codemirror.js')}}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='mode/clike/clike.js')}}" type="text/javascript"></script>

    <link rel="stylesheet" media="all" href="{{ url_for('static', filename='css/codemirror.css')}}" />

    <!-- Requires Mergely -->
    <script src="{{ url_for('static', filename='js/mergely.js')}}" type="text/javascript"></script>
    <link rel="stylesheet" media="all" href="{{ url_for('static', filename='css/mergely.css')}}" />

    <link rel="stylesheet" media="all" href="{{ url_for('static', filename='css/style.css')}}" />

    <!-- Script for diff production -->
    <script src="{{ url_for('static', filename='js/experiment.js')}}" type="text/javascript"></script>

    <!-- Colorize Java code from chatGPT -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.min.css">
    <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-java.min.js"></script>

    <style>
        .lint-error {font-family: arial; font-size: 80%; background: #fcfa96; color: #a00; padding: 2px 5px 3px; border: 1px solid black;}
        .lint-error-icon {color: white; background-color: red; font-weight: bold; border-radius: 50%; padding: 0 3px; margin-right: 7px;}
    </style>
   <style>
      .rsme-question{
          margin:0 0 .5rem 0;
          font-weight:600;
      }
      .rsme-wrapper{
          display:flex;
          align-items:center;     /* slider & labels side-by-side */
          gap:.75rem;
      }
      /* vertical slider */
      .rsme-slider{
          /* 150 mm -> ≈567 px (150 mm × 3.78 px/mm) */
          height:567px;
          width:1.4rem;
          direction: rtl;
          writing-mode:bt-lr;               /* Firefox */
          -webkit-appearance:slider-vertical;/* Chrome/Safari */
      }
      .rsme-labels{
          display: flex;
          list-style:none;
          padding:0;
          margin:0;
          font-size:.9rem;
          line-height:1.2;
          user-select:none;
          flex-direction: column-reverse;
      }
      .rsme-labels li{
          position:relative;
          height: calc(567px / 15 * 2); /* crude spacing that matches ~10 mm ticks */
          display:flex;
          align-items:center;
      }
      /* optional tick mark */
      .rsme-labels li::before{
          content:"";
          width:.6rem;
          height:2px;
          background:#555;
          margin-right:.3rem;
      }
    </style>

    <script type="text/javascript">
        $(document).ready(function () {
            logData("pageLoaded", "pageLoaded");

            //size of screen
            logData("screen height", window.screen.height);
            logData("screen width", window.screen.width);

            // Size of browser viewport.
            logData("window height", $(window).height());
            logData("window width", $(window).width());

            // Size of HTML document (same as pageHeight/pageWidth in screenshot).
            logData("html document height", $(document).height());
            logData("html document width", $(document).width());

            $("#button-continue").click(function(){
                $("#div-mergely").show();
                $("#button-continue").hide();

                logData("read_instructions", "read_instructions");
                var width = $(window).width() - 50;
                {% for code in codes %}
                    initMergely('#compare{{code["id"]}}',
                        parseInt('{{code["linecount"]}}') * 18.5 + 17,
                        parseInt('{{code["contextLineCount"]}}') * 18.5,
                        width,
                        parseInt('{{code["left_line_number"]}}'),
                        '{{code["left_content"] | safe}}',
                        parseInt('{{code["right_line_number"]}}'),
                        '{{code["right_content"] | safe}}',
                        '{{code["prefix_line_count"]}}',
                        '{{code["prefix_escaped"]}}',
                        '{{code["suffix_escaped"]}}');
                {% endfor %}

                if ('{{ is_primed }}' == 'True'){
                    var instance = $("#compare0").mergely('cm', 'rhs');
                    var msg = document.createElement("div");
                    var icon = msg.appendChild(document.createElement("span"));
                    icon.innerHTML = "!!";
                    icon.className = "lint-error-icon";
                }

                var editors = [];
                var name = "#compare";
                var compareName = "compare";
                for(let i = 0; i < 5; i++) {
                    var hunkName = name + i;
                    var editor = $(hunkName).mergely('cm', 'rhs');
                    editors[i] = editor;

                    var compareSpecificName = compareName + i;
                    var internalBar = document.getElementById(compareSpecificName).getElementsByClassName("CodeMirror-vscrollbar");
                    internalBar[1].onscroll = function (ev) {
                        recomputeLinesScroll(i);
                        scrollHandler();
                    };
                }
                setEditors(editors);
                computeLinesInHunk("none", 0);
                logData('visibleHunks', determineVisibleHunks());
	            logData('visibleLines', determineVisibleLines());

            });

            // Window scroller
            window.onscroll = function (ev) {scrollHandler()};
            window.addEventListener('resize', recomputeLinesScroll(-1));

            var ctrl = false;
            document.addEventListener("keydown", function(e) {
                if(e.which == 17 || e.which == 224 || e.which == 91) {
                    ctrl = true
                }
                if(e.which == 70 && ctrl == true){
                    logData("button", "ctrl+F")
                }
            }, true);

            document.addEventListener("keyup", function(e) {
                if(e.which == 17 || e.which == 224 || e.which == 91) {
                    ctrl = false;
                }
            });
        });

        /**
        * Check if the user really wants to complete the review
        */
        function validateReview() {
	    if (confirm('Do you want to complete the review?')) {
		    showquestions();
	        }
        }

        function showquestions(){
            logData("end_cr_experiment", "clickshowquestions");
            disableRemarks();
            disableScrollRecording();
            $("#review-completed").hide();
            $("#id01").hide();
            $("#final-questions").show();
        }

        function shownextquestion(){
            $("#final-questions").hide();
            $("#continue-question").show();
        }
    </script>
    <style>
        li {
            padding-bottom: 10px;
        }
    </style>

<style>
  html, body { margin:0; height:100%; font-family: system-ui, sans-serif; }

  /* Sidebar fixed on the left, 30% width */
  #chat-sidebar{
    position: fixed; left:0; top:0; bottom:0;
    width: var(--chatW, 30%);
    background:#f9f9f9; border-right:1px solid #ddd;
    display:flex; flex-direction:column; z-index:1000;
  }
body {
      /* Push the main page content to the right to make room for the sidebar */
      margin-left: 30%;
      transition: margin-left 0.3s ease;
      box-sizing: border-box;
    }

  header#chat-title{
    padding:10px 12px; border-bottom:1px solid #ddd;
    font-size:1.05rem; font-weight:600;
  }

  #chat-messages{ flex:1; overflow-y:auto; padding:14px 10px; }
  .message{ display:flex; margin-bottom:12px; }
  .message.user2{ justify-content:flex-end; }
  .message.bot2 { justify-content:flex-start; }
  .bubble{
    max-width:70%; padding:8px 10px; border-radius:8px;
    word-wrap:anywhere; line-height:1.35;
    box-shadow:0 0 0 1px rgba(0,0,0,.04);
  }
  .user2 .bubble{ background:#DCF8C6; }
  .bot2  .bubble{ background:#eee; color:#111; }
  .bubble img{ max-width:100%; border-radius:6px; display:block; }

  #chat-input-area{
    display:flex; align-items:center; gap:6px;
    padding:8px; border-top:1px solid #ddd; background:#fff;
  }
  .square-btn{
    width:40px; height:40px; border:none; color:#fff; background:#007aff;
    border-radius:4px; cursor:pointer; font-size:19px;
    display:flex; align-items:center; justify-content:center;
  }
  .square-btn:disabled{ opacity:.5; cursor:not-allowed; }
  #text-input{
    flex:1; 
    padding:8px; 
    border:1px solid #ccc; 
    border-radius:4px;
    resize:none;               
    overflow-y:auto;           
    line-height:1.35;
    max-height:40vh;           
    font-family: inherit;      
    font-size: 1rem;
  }

  /* === Resize handle on the right edge === */
  #chat-resizer{
    position:absolute; top:0; right:0; height:100%;
    width:8px; cursor:col-resize;
    /* wider hit target on touch devices */
    touch-action: none;
  }
  /* While dragging, show resize cursor everywhere */
  body.resizing{ cursor: col-resize; }

  /* Optional mobile mode: sidebar at top */
  @media (max-width:800px){
    #chat-sidebar{ width:100%; height:38%; max-width:none; bottom:auto; }
    main{ margin-left:0; margin-top:38%; }
  }
</style>

<style>
  /* --- Code formatting --- */
  .bubble pre.code-block {
    position: relative;
    margin: 8px 0;
    padding: 12px 12px 12px 12px;
    border-radius: 8px;
    background: #0b0d0e;     /* dark block like chatgpt.com */
    color: #e6edf3;
    overflow: auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    line-height: 1.45;
    border: 1px solid rgba(255,255,255,0.06);
  }
  .bubble pre.code-block code {
    white-space: pre;
    display: block;
  }

  .bubble .code-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .5rem;
    font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    background: #111315;
    color: #9da7b3;
    padding: 8px 10px;
    border: 1px solid rgba(255,255,255,0.06);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
  }
  .bubble .code-header .lang {
    opacity: 0.9;
  }
  .bubble .copy-btn {
    border: 1px solid rgba(255,255,255,0.12);
    background: #1a1d1f;
    color: #cbd5e1;
    border-radius: 6px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
  }
  .bubble .copy-btn:active {
    transform: translateY(1px);
  }

  /* Inline `code` in normal paragraphs */
  .bubble p code, .bubble li code, .bubble span.inline-code {
    background: rgba(2, 6, 23, 0.08);
    border: 1px solid rgba(0,0,0,0.08);
    padding: 0 .3em;
    border-radius: 4px;
    font: 12.5px/1.3 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
</style>
 
</head>
<style>
    #mergely-splash { display: none !important;}
</style>
<body>
    <div>
        <p><h1>Review Task</h1></p>
        <p>We are now going to show you the code changes to review.</p>
        <p>Please take the review task <strong>very seriously</strong> (this is critical for the scientific validity of this experiment).</p>

        <h3>Information</h3>
        <ul>
            <li>The old version of the code is on the left, the new version is on the right.</li>
            <li><strong>Review comments</strong></li>
            <ul>
                <li>To <strong>add</strong> a review comment, click on the corresponding line number.</li>
                <li>To <strong>modify/delete</strong> a review comment, click on the corresponding line number again and modify/delete the comment's text</li>
            </ul>
            <li><strong>Usage of genAI</strong></li>
            <ul>
                <li>When you click a button in the top middle of the screen with the dialogue icon, a window with <strong>ChatGPT</strong> (model GPT-4o) will appear on your left</li>
                <li>You are encouraged to use it as you see fit. Please do <strong>NOT</strong> use your own genAI for this experiment.</li>
                <li>The prompts you make will be recorded for analysis. Please be noted.</li>
            </ul>
            <li>Once you confirm to conclude the review, it will not be possible to add, delete, or modify the remarks anymore.</li>
            <li><strong>Please do not reload the page under any circumstances lest the experiment will be rendered incomplete!</strong></li>
        </ul>

    </div>
    <div>
        <form method="get" id="button-continue">
            <button type="button" class="button blue" style="height: 50px;">I have read the text above and I want to start the review ►</button><br><br>
        </form>
    </div>
    <div class="mergely-full-screen-8" style="overflow-y: scroll; display: none" id="div-mergely">
        <div class="mergely-resizer">
            {% for code in codes %}
                <table width="100%">
                    <tbody>
                        <tr>
                            <td width="50%" style="font-size:15px;">{{ code['filename'] }}</td>
                            <td style="font-size:15px;">{{ code['filename'] }}</td>
                        </tr>
                    </tbody>
                </table>
                <div id="compare{{code['id']}}" class="hunk"></div><br/>
            {% endfor %}
        </div>

        <div style="clear: both;">
            <button id="review-completed" onclick="document.getElementById('id01').style.display='block'" class="button blue" style="height: 50px;">I have completed my review</button>
        </div>

        <div style="clear: both; display: none" id="final-questions">
                <!-- "diff_data" is a fieldset with a textarea inside containing JSON formatted log data. Doing this
                we do not need to manipulate data in a submission function due Flask post request mechanics-->
            <form action="{{ url_for('run_experiment') }}" method="post">
                <fieldset id="diff_data" hidden style="display: none">
                    <textarea name="hidden_log" id="hidden_log"></textarea>
                </fieldset>
                {{ md_body|safe }}
                <br>
                <fieldset id="fieldset_question_5" class="container_radio_buttons">
                    <p>How long have you been interrupted during the execution of the review?</p>
                    <label><input type="radio" name="question_interruption_time2" id="question_interruption_time_a0" value="0" class="option-input radio" required>No interruption time</label><br>
                    <label><input type="radio" name="question_interruption_time2" id="question_interruption_time_a1" value="1" class="option-input radio">1-2 minutes</label><br>
                    <label><input type="radio" name="question_interruption_time2" id="question_interruption_time_a2" value="2" class="option-input radio">up to 5 minutes</label><br>
                    <label><input type="radio" name="question_interruption_time2" id="question_interruption_time_a3" value="3" class="option-input radio">up to 10 minutes</label><br>
                    <label><input type="radio" name="question_interruption_time2" id="question_interruption_time_a4" value="4" class="option-input radio">more than 10 minutes</label><br>
                </fieldset>
                <br>
  <div id="mental-effort-block">
  <p class="rsme-question">
    How much mental effort did the task require?
  </p>
     <div class="rsme-wrapper">
      <!-- the 150-mm, 0-to-150 slider -->
      <input type="range"
             name="RSME_task_2"
             id="rsme"
             class="rsme-slider"
             min="0" max="150" step="1" value="75"
             orient="vertical"  />

      <!-- anchor labels -->
      <ul class="rsme-labels">
        <li data-value="0">No effort at all</li>
        <li data-value="10">Almost no effort</li>
        <li data-value="20">Very little effort</li>
        <li data-value="30">Small effort</li>
        <li data-value="50">Considerable effort</li>
        <li data-value="80">Very large effort</li>
        <li data-value="110">Extremely large effort</li>
      </ul>
    </div>
  </div>
  <button type="submit" id="submitter" class="button blue">Next ►</button>

            </form>
        </div>

    <div id="id01" class="modal">

        <form class="modal-content animate">
            <div class="imgcontainer">
                <span onclick="document.getElementById('id01').style.display='none'" class="close" title="Close">&times;</span>
            </div>

            <div class="container-popup">
                <p> Do you want to complete the review? </p>

                <br>

                <div class="btn-group" style="text-align: center;">
                    <button type="button" onclick="document.getElementById('id01').style.display='none'" class="button-popup blue">No</button>
                    <button type="button" onclick="showquestions();" class="button-popup blue">Yes</button>
                </div>
            </div>
        </form>
    </div>

    <div id="remark-popup-window" class="modal">

        <form class="modal-content animate" onkeypress="return event.keyCode != 13">
            <div class="imgcontainer">
                <span onclick="document.getElementById('remark-popup-window').style.display='none'" class="close" title="Close">&times;</span>
            </div>

            <div class="container-popup">
                <label><b>Please enter review remark:</b></label>
                <input type="text" placeholder="Remark" name="remark" onkeypress="return runScript(event)" id="review-remark" required>

                <br>

                <div class="btn-group" style="text-align: center;">
                    <button type="button" onclick="document.getElementById('remark-popup-window').style.display='none'" class="button-popup blue">Cancel</button>
                    <button type="button" onclick="document.getElementById('remark-popup-window').style.display='none'; recordRemark();" class="button-popup blue">Ok</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        function runScript(e) {
            if (e.keyCode == 13 && areRemarksEnabled()) {
                document.getElementById('remark-popup-window').style.display='none';
                recordRemark();
            }
        }
    </script>

    <style type="text/css">
        #dialog {
            width:      200px;
            margin:     auto;
            padding:    10px;
            border:     thin solid black;
            background: lightgreen;
        }
        .hidden {
            display: none;
        }
    </style>


<aside id="chat-sidebar">
  <header id="chat-title">AI Chat</header>

  <div id="chat-messages" aria-live="polite"></div>

  <div id="chat-input-area">
    <button id="send-image" class="square-btn" title="Send image" aria-label="Send image">🖼️</button>
    <textarea id="text-input" placeholder="Type a message… (Shift+Enter = newline)"></textarea>
    <input id="image-input" type="file" accept="image/*" style="display:none">
    <button id="send-text" class="square-btn" title="Send text" aria-label="Send text">➤</button>
    <div id="chat-resizer" aria-hidden="true"></div>
  </div>
</aside>

<script>
/* =======================
   Config
======================= */
const SYSTEM_PROMPT = "You are ChatGPT, a helpful assistant.";
const CHAT_ENDPOINT = "/chat-api";     // Replace with your backend route
const USE_SERVER_LOG = true;

const SESSION_KEY = "chatSessionId";

/* Only these actions render as bubbles; others are logged only */
const RENDERABLE = new Set(["user_text2","user_image2","ai_text2","ai_image2"]);
const ACTION_TO_VIEW = {
  user_text2: { role:"user2", isImage:false },
  user_image2:{ role:"user2", isImage:true  },
  ai_text2:   { role:"bot2",  isImage:false },
  ai_image2:  { role:"bot2",  isImage:true  },
};

const chatArea    = document.getElementById("chat-messages");
const textInput   = document.getElementById("text-input");
const sendTextBtn = document.getElementById("send-text");
const sendImgBtn  = document.getElementById("send-image");
const imageInput  = document.getElementById("image-input");

let chatLogFull = [];   // all records (including analytics)
let chatLog     = [];   // only renderable records, roles are "user2"/"bot2"

/* Session id */
let sessionId = localStorage.getItem(SESSION_KEY);
if(!sessionId){
  sessionId = (crypto.randomUUID ? crypto.randomUUID() :
               Math.random().toString(36).slice(2) + Date.now());
  localStorage.setItem(SESSION_KEY, sessionId);
}

function scrollToEnd(){ chatArea.scrollTop = chatArea.scrollHeight; }

function autosizeTextarea(el){
  el.style.height = "auto";
  el.style.height = Math.min(el.scrollHeight, window.innerHeight * 0.4) + "px";
}

function addBubble(role, content, isImage=false){
  const wrap = document.createElement("div");
  wrap.className = `message ${role}`;
  const bubble = document.createElement("div");
  bubble.className = "bubble";

  if(isImage){
    const img = new Image();
    img.src = content; img.alt = "sent image";
    bubble.appendChild(img);
  }else {
      if (role === "bot2") {
        // AI output: auto-detect and render code blocks + inline code
        const frag = renderAIMessageHtml(String(content ?? ""));
        bubble.appendChild(frag);
        if (window.Prism && Prism.highlightAllUnder) Prism.highlightAllUnder(bubble); // Prism
      } else {
        // User text is plain
        bubble.textContent = content;
      }
  }
  wrap.appendChild(bubble);
  chatArea.appendChild(wrap);
  scrollToEnd();
}

function initResizableSidebar(){
  const sidebar = document.getElementById("chat-sidebar");
  const resizer = document.getElementById("chat-resizer");
  if(!sidebar || !resizer) return;

  const KEY = "chatW_px";               // per-page-session persistence
  const MIN = 260;                      // px
  const MAX = () => Math.min(innerWidth * 0.95, 1200);

  // restore previous width for this tab
  const saved = sessionStorage.getItem(KEY);
  if (saved) sidebar.style.setProperty("--chatW", `${parseInt(saved,10)}px`);

  let startX = 0, startW = 0;

  resizer.addEventListener("pointerdown", (e) => {
    startX = e.clientX;
    startW = sidebar.getBoundingClientRect().width;

    document.body.classList.add("resizing");
    resizer.setPointerCapture(e.pointerId);

    const onMove = (ev) => {
      const dx = ev.clientX - startX;
      const w  = Math.max(MIN, Math.min(MAX(), startW + dx));
      sidebar.style.setProperty("--chatW", `${w}px`);
    };

    const onUp = (ev) => {
      // persist for this tab only
      const w = parseInt(getComputedStyle(sidebar).getPropertyValue("--chatW"), 10);
      if (!Number.isNaN(w)) sessionStorage.setItem(KEY, String(w));

      document.body.classList.remove("resizing");
      window.removeEventListener("pointermove", onMove);
      window.removeEventListener("pointerup", onUp);
    };

    window.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", onUp);
  });

  // Double-click the bar to reset back to the default (30vw)
  resizer.addEventListener("dblclick", () => {
    sessionStorage.removeItem(KEY);
    sidebar.style.removeProperty("--chatW");
  });

  // Keep clamped when viewport changes
  window.addEventListener("resize", () => {
    const raw = sessionStorage.getItem(KEY);
    if (!raw) return;
    const w = Math.max(MIN, Math.min(MAX(), parseInt(raw,10)));
    sidebar.style.setProperty("--chatW", `${w}px`);
    sessionStorage.setItem(KEY, String(w));
  });
}

/* =========
   Logging
=========== */
function logLine(action, data){
  logData(action, data); 
  chatLogFull.push({ ts: Date.now(), action, data, sessionId });
}

/* Short hash helper for logging images without full base64 */
async function sha256Hex(str){
  const buf = new TextEncoder().encode(str);
  const digest = await crypto.subtle.digest("SHA-256", buf);
  return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* Send text */
async function handleTextSend(){
  const text = textInput.value.replace(/\r?\n$/, "").trim();
  if(!text) return;

  textInput.value = "";
  autosizeTextarea(textInput);
  addBubble("user2", text);
  chatLog.push({ time: Date.now(), role:"user2", content: text, isImage:false });

  logLine("user_text2", text);

  queryAI({ text });
}

/* Send image */
function handleImageFile(file){
  const reader = new FileReader();
  reader.onload = async () => {
    const imgData = reader.result;
    addBubble("user2", imgData, true);
    chatLog.push({ time: Date.now(), role:"user2", content: imgData, isImage:true });

    let hash = "n/a";
    try{ hash = await sha256Hex(imgData); }catch(_){}
    logLine("user_image2", `sha256:${hash};bytes:${imgData.length}`);

    queryAI({ image: imgData });
  };
  reader.readAsDataURL(file);
}

  // --- Utilities for safe HTML ---
  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, m => (
      m === '&' ? '&amp;' :
      m === '<' ? '&lt;'  :
      m === '>' ? '&gt;'  :
      m === '"' ? '&quot;': '&#39;'));
  }

  // Split text into segments with code fences ```lang\n...\n```
  // Returns an array of {type:"code"| "text", lang?, content}
  function splitFencedCode(text) {
    const out = [];
    const fence = /```([\w+-]*)\n([\s\S]*?)```/g;
    let last = 0, m;
    while ((m = fence.exec(text)) !== null) {
      if (m.index > last) {
        out.push({ type: "text", content: text.slice(last, m.index) });
      }
      out.push({ type: "code", lang: (m[1] || "").toLowerCase(), content: m[2] });
      last = fence.lastIndex;
    }
    if (last < text.length) out.push({ type: "text", content: text.slice(last) });
    return out;
  }

  // Light markdown-ish to HTML for normal text:
  // - paragraphs
  // - inline code `...`
  function renderTextWithInlineCode(s) {
    // Escape everything first
    let html = escapeHtml(s);

    // Inline code: `...`
    html = html.replace(/`([^`]+)`/g, (_,$1) => `<span class="inline-code">${$1}</span>`);

    // Simple paragraphs (split on double newlines)
    const parts = html.split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`);
    return parts.join("");
  }

  // Build a bubble DOM node for AI text that may contain code fences
  function renderAIMessageHtml(text) {
    const frag = document.createDocumentFragment();
    const blocks = splitFencedCode(text);

    for (const b of blocks) {
      if (b.type === "code") {
        const lang = b.lang || "text";
        const header = document.createElement("div");
        header.className = "code-header";
        header.innerHTML = `<span class="lang">${escapeHtml(lang)}</span>
                            <button class="copy-btn" type="button">Copy</button>`;

        const pre = document.createElement("pre");
        pre.className = "code-block";
        const code = document.createElement("code");
        code.className = lang ? `language-${lang}` : "";
        code.textContent = b.content.replace(/\n+$/, ""); // trim trailing newlines
        pre.appendChild(code);

        // Prism highlighting (optional)
        // if (window.Prism && Prism.highlightElement) Prism.highlightElement(code);  // Prism

        const wrapper = document.createElement("div");
        wrapper.appendChild(header);
        wrapper.appendChild(pre);
        frag.appendChild(wrapper);
      } else {
        const div = document.createElement("div");
        div.innerHTML = renderTextWithInlineCode(b.content);
        frag.appendChild(div);
      }
    }
    return frag;
  }

  // Copy button (event delegation)
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".copy-btn");
    if (!btn) return;
    const pre = btn.parentElement?.nextElementSibling; // .code-header -> <pre>
    const code = pre?.querySelector("code");
    if (!code) return;
    try {
      await navigator.clipboard.writeText(code.textContent || "");
      const old = btn.textContent;
      btn.textContent = "Copied";
      setTimeout(() => (btn.textContent = old), 1200);
    } catch {
      // fallback
      const rng = document.createRange();
      rng.selectNodeContents(code);
      const sel = getSelection();
      sel.removeAllRanges();
      sel.addRange(rng);
      document.execCommand("copy");
      sel.removeAllRanges();
    }
  });

/* Talk to backend */
async function queryAI({ text=null, image=null }){
  const payload = {
    system_prompt: SYSTEM_PROMPT,
    sessionId,
    history: chatLog,      // roles are "user2"/"bot2"
    new_user_text2: text,
    new_user_image2: image
  };

  logLine("request_dispatch", JSON.stringify({ hasText: !!text, hasImage: !!image }));

  setSending(true);

  try{
    const res = await fetch(CHAT_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();

    if(data.type === "image"){
      addBubble("bot2", data.content, true);
      chatLog.push({ time: Date.now(), role:"bot2", content:data.content, isImage:true });
      logLine("ai_image2", data.content);
    }else{
      addBubble("bot2", data.content, false);
      chatLog.push({ time: Date.now(), role:"bot2", content:data.content, isImage:false });
      logLine("ai_text2", data.content);
    }
  }catch(err){
    addBubble("bot2", "⚠️ Error contacting server.");
    logLine("error", String(err));
    console.error(err);
  }finally{
    setSending(false);
  }
}

function setSending(b){
  sendTextBtn.disabled = b;
  sendImgBtn.disabled  = b;
  textInput.disabled   = b;
}

/* Wire events & boot */
sendTextBtn.addEventListener("click", handleTextSend);
textInput.addEventListener("keydown", (e) => {
  if (e.isComposing) return;                      
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();                           
    handleTextSend();
  }
});

sendImgBtn.addEventListener("click", () => imageInput.click());
imageInput.addEventListener("change", () => {
  if(imageInput.files && imageInput.files[0]) handleImageFile(imageInput.files[0]);
});
textInput.addEventListener("input", () => autosizeTextarea(textInput));

autosizeTextarea(textInput);
initResizableSidebar();

</script>

</body>
</html>
